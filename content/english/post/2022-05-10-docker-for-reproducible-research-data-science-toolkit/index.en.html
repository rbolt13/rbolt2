---
title: Docker for reproducible research - Data Science Toolkit
author: Randi Bolt
date: '2022-05-10'
slug: []
categories:
  - undergrad
tags:
  - docker
---



<p>This is part 1 of my notes on <em>Docker for reproducible research</em> from <a href="https://benkeser.github.io/info550/">Data Science Toolkit</a>, by David Benkeser.</p>
<p><a href="https://benkeser.github.io/info550/recordings/docker-for-reproducible-research">Video</a> | <a href="https://benkeser.github.io/info550/lectures/11_docker/docker.html#1">Notes</a> | <a href="https://github.com/benkeser/info550/tree/master/lectures/11_docker">Github</a></p>
<div id="part-1-000---3250" class="section level1">
<h1>Part 1 (0:00 - 32:50)</h1>
<div id="pre-lecture-question" class="section level2">
<h2>Pre-lecture Question</h2>
<p>Q: Can we review project organization?</p>
<div id="phony-data-analysis" class="section level3">
<h3>Phony data analysis</h3>
<ol style="list-style-type: decimal">
<li><span class="math inline">\(\underline{\text{Create and Open Project then Create Folders}}\)</span></li>
</ol>
<p>In the terminal:</p>
<ul>
<li><p>mkdir example_project_2 <span class="math inline">\(\quad\quad\quad\text{: make  directory }\)</span></p></li>
<li><p>subl example_project_2 <span class="math inline">\(\quad\quad\quad\quad\text{: open in sublime }\)</span></p></li>
</ul>
<p>Then in a terminal in sublime create some folders:</p>
<ul>
<li><p>mkdir code <span class="math inline">\(\quad\quad\quad\quad\quad\quad\quad\text{: make  directory }\)</span></p></li>
<li><p>mkdir raw data <span class="math inline">\(\quad\quad\quad\quad\quad\quad\text{: make directory }\)</span></p></li>
<li><p>mkdir clean data <span class="math inline">\(\quad\quad\quad\quad\quad\quad\text{: make  directory }\)</span></p></li>
<li><p>mkdir output <span class="math inline">\(\quad\quad\quad\quad\quad\quad\quad\text{: make  directory }\)</span></p></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><span class="math inline">\(\underline{\text{Save Raw Data}}\)</span></li>
</ol>
<p>In the terminal:</p>
<ul>
<li><p>R <span class="math inline">\(\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\text{: open R }\)</span></p></li>
<li><p>data(mtcars) <span class="math inline">\(\quad\quad\quad\quad\quad\quad\quad\text{: load mtcars data set }\)</span></p></li>
<li><p>head(mtcars) <span class="math inline">\(\quad\quad\quad\quad\quad\quad\quad\text{: show head of mtcars }\)</span></p></li>
<li><p>getwd() <span class="math inline">\(\quad\quad\quad\quad\quad\quad\quad\quad\quad\text{: get working directory }\)</span></p></li>
<li><p>saveRDS(mtcars, “raw_data/mtcars.rds”) <span class="math inline">\(\quad\text{: save as .rds file}\)</span></p></li>
<li><p>saveRDS(mtcars, “raw_data/mtcars.RData”) <span class="math inline">\(\quad\text{: save as .RData file}\)</span></p></li>
<li><p>q() <span class="math inline">\(\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\text{: quit R }\)</span></p></li>
<li><p>y <span class="math inline">\(\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\text{: agree to quit }\)</span></p></li>
<li><p>rm raw_data/mtcars.RData <span class="math inline">\(\quad\quad\text{: remove data from folder}\)</span></p></li>
</ul>
<p>Note that <code>.Rds</code> is preferred.</p>
<ol start="3" style="list-style-type: decimal">
<li><span class="math inline">\(\underline{\text{Create Clean Data File}}\)</span></li>
</ol>
<p>[command] [N] : to create a new file.</p>
<p>Then save that file in the code directory as “clean_data.R” with the following code:</p>
<p><img src="img/clean_data_file_img.png" /></p>
<p>Note the 3 different places the here package is used.</p>
<ol start="4" style="list-style-type: decimal">
<li><span class="math inline">\(\underline{\text{Create Makefile}}\)</span></li>
</ol>
<p>[command] [N] : to create a new file.</p>
<p>Then save that file in the project directory as “Makefile” with the following code:</p>
<p><img src="img/make_file_img.png" /></p>
<p>In the terminal:</p>
<ul>
<li><p>make clean_data/mtcars_cleaned.rds</p></li>
<li><p>Rscript code/clean_data.R</p></li>
</ul>
<p>Verify data is in clean_data folder</p>
<ol start="5" style="list-style-type: decimal">
<li><span class="math inline">\(\underline{\text{Create make table file}}\)</span></li>
</ol>
<p>[command] [N] : to create a new file.</p>
<p>Then save that file in the code folder as “make_table.R” with the following code:</p>
<p><img src="img/make_table_img.png" /></p>
<ol start="6" style="list-style-type: decimal">
<li><span class="math inline">\(\underline{\text{Update Makefile}}\)</span></li>
</ol>
<p>Now update the Makefile with the following:</p>
<p><img src="img/update_make_file_img.png" /></p>
<p>In the terminal:</p>
<ul>
<li>make output/data_for_table.rds</li>
</ul>
<p>Verify contents in output folder.</p>
<ol start="7" style="list-style-type: decimal">
<li><span class="math inline">\(\underline{\text{Create report.Rmd}}\)</span></li>
</ol>
<p>[command] [N] : to create a new file.</p>
<p>Then save that file in the project directory as “report.Rmd” with the following code:</p>
<p><img src="img/rmd_img.png" /></p>
<ol start="8" style="list-style-type: decimal">
<li><span class="math inline">\(\underline{\text{Update Makefile}}\)</span></li>
</ol>
<p>Update the Makefile with the following:</p>
<p><img src="img/update2_make_file_img.png" /></p>
<p>In the terminal:</p>
<ul>
<li><p>make report.html</p></li>
<li><p>open report.html</p></li>
</ul>
</div>
</div>
<div id="pre-lecture-question-2" class="section level2">
<h2>Pre-lecture Question (2)</h2>
<p>Q: why doesn’t git / github recognize empty folders?</p>
<p>A: git doesn’t care about empty folders in directory.</p>
<div id="make-github-aware-of-empty-folder" class="section level3">
<h3>Make Github aware of empty folder</h3>
<p>In terminal</p>
<ul>
<li><p>rm output/* <span class="math inline">\(\quad\quad\quad\quad\text{: remove everything in output folder}\)</span></p></li>
<li><p>gitinit <span class="math inline">\(\quad\quad\quad\quad\quad\quad\text{: initilize git}\)</span></p></li>
<li><p>git status <span class="math inline">\(\quad\quad\quad\quad\quad\text{: status}\)</span></p></li>
</ul>
<p>Notice the output folder isn’t included.</p>
<ul>
<li><p>cd output <span class="math inline">\(\quad\quad\quad\quad\quad\text{: change to output directory}\)</span></p></li>
<li><p>touch .gitkeep <span class="math inline">\(\quad\quad\quad\text{: add empty file}\)</span></p></li>
<li><p>ls -a <span class="math inline">\(\quad\quad\quad\quad\quad\quad\text{: list all files}\)</span></p></li>
<li><p>cd .. <span class="math inline">\(\quad\quad\quad\quad\quad\quad\text{: change directory up one level}\)</span></p></li>
<li><p>gitstatus <span class="math inline">\(\quad\quad\quad\quad\quad\text{: status}\)</span></p></li>
</ul>
<p>Now the output folder is visible.</p>
</div>
</div>
</div>
<div id="part-2-docker-3300---11650" class="section level1">
<h1>Part 2: Docker (33:00 - 1:16:50)</h1>
<p>The problem: there are things on your computer that have nothing to do with R that R depends on. R wont help you track those dependencies. Renv only helps make sure R packages are up to date.</p>
<p>You can download R code from github, but that doesn’t mean you can run it.</p>
<div id="key-principle-software-is-code" class="section level3">
<h3>Key Principle: <span style="color: red;">Software is Code!</span></h3>
<ul>
<li><p>running code requires software</p></li>
<li><p>we want a way to package up all analysis and code AND software</p></li>
</ul>
<p>Containerization gives us a way to do this.</p>
<ul>
<li>Docker is a popular containerization program</li>
</ul>
<p>Think of a Docker container as a virtual machine:</p>
<ul>
<li><p>Hos its own (Unix) operating system</p></li>
<li><p>Has its own file system</p></li>
<li><p>Has its own software application</p></li>
</ul>
<p>(A computer within a computer)</p>
</div>
<div id="images-vs.-containers" class="section level3">
<h3>Images Vs. Containers</h3>
<p>Docker image:</p>
<ul>
<li><p>source code, libraries, dependencies, tools, and other files needed to run a container.</p></li>
<li><p>a blueprint for the enviroment in which you will execute your analysis</p></li>
</ul>
<p>Docker container:</p>
<ul>
<li><p>created when we run an image</p></li>
<li><p>contruct a run-time enviroment to execute your code</p></li>
<li><p>or provide an interactive way to excecute code.</p></li>
</ul>
</div>
<div id="how-does-it-work" class="section level3">
<h3>How does it work?</h3>
<ul>
<li><p>Docker installed program.</p></li>
<li><p>Write a Dockerfile, plain text that tells Docker what to put in image.</p></li>
<li><p>build the image</p></li>
<li><p>run the image (creating container) to execute code.</p></li>
</ul>
</div>
<div id="interactive-ubuntu-container" class="section level2">
<h2>Interactive Ubuntu container</h2>
<p>In the terminal:</p>
<ul>
<li>docker pull ubuntu <span class="math inline">\(\quad\quad\quad\text{: this is downloading an image from the internet}\)</span></li>
</ul>
<p>This is installing an empty ubuntu operating system.</p>
<p>If you have issues with this step check out this stack overflow link <a href="https://stackoverflow.com/questions/52698748/connection-refused-on-pushing-a-docker-image">here</a> or <a href="https://stackoverflow.com/questions/2333400/what-can-be-the-reasons-of-connection-refused-errors">here</a>.</p>
<ul>
<li>docker run -it ubuntu /bin/bash <span class="math inline">\(\quad\text{: puts you inside interactive (-it) ubuntu operating system}\)</span></li>
</ul>
<p>In a different terminal on your computer:</p>
<ul>
<li>docker container ps <span class="math inline">\(\quad\text{: prints all the containers you have running}\)</span></li>
</ul>
<p>Back inside docker terminal:</p>
<ul>
<li><p>touch my_file_in_my_container <span class="math inline">\(\quad\quad\text{: add file to container}\)</span></p></li>
<li><p>exit <span class="math inline">\(\quad\quad\quad\quad\quad\quad\quad\quad\quad\text{: container stops running}\)</span></p></li>
<li><p>docker container ps <span class="math inline">\(\quad\quad\quad\quad\text{: see the docker container no longer exists}\)</span></p></li>
<li><p>docker run -it ubuntu /bin/bash <span class="math inline">\(\quad\quad\text{: start a docker container}\)</span></p></li>
</ul>
<p>Notice this is a different container, and the file that was created no longer exists.</p>
<p><strong>Containers are transient!</strong></p>
<ul>
<li>exit <span class="math inline">\(\quad\quad\quad\quad\quad\quad\quad\quad\quad\text{: exit container}\)</span></li>
</ul>
<div id="adding-a-text-editor-to-a-docker-file" class="section level3">
<h3>Adding a text editor to a docker file</h3>
<p>In the terminal:</p>
<ul>
<li><p>mkdir docker_ex <span class="math inline">\(\quad\quad \text{: created docker_ex directory}\)</span></p></li>
<li><p>subl docker_ex <span class="math inline">\(\quad\quad\text{: open in sublime}\)</span></p></li>
</ul>
<p>[command] [s] : save file as “Dockerfile”</p>
<p><img src="img/dockerfile_img01.png" /></p>
<ul>
<li><p><strong>FROM</strong> : gives a starting point at the ubuntu operating system.</p></li>
<li><p>apt-get: is a package management system in ubuntu</p></li>
<li><p>update: make sure apt-get is up to date</p></li>
<li><p>install vim: installs the text editor vim</p></li>
<li><p><strong>Run</strong>: Docker syntax that tells it to run those two commands from the ubuntu operating system.</p></li>
</ul>
<p>Now back in the terminal:</p>
<ul>
<li><p>cd docker_example/</p></li>
<li><p>ls</p></li>
<li><p>docker build -t ubuntu_plus_vim . <span class="math inline">\(\quad\quad\text{build docker file from current directory (thats what &quot;.&quot; means)}\)</span></p></li>
</ul>
<p>Docker is angery because we aren’t inside the container to hit yes.</p>
<p>Fix: add “-y” to code (line 7) that says yes:</p>
<p><img src="img/dockerfile_img_02.png" /></p>
<p>Now that it works lets run it.</p>
<ul>
<li><p>docker run -it ubuntu_plus_vim /bin/bash <span class="math inline">\(\quad\quad\text{: open up ubunto with vim that we just created}\)</span></p></li>
<li><p>vim <span class="math inline">\(\quad\quad\text{opens text editor for editing}\)</span></p></li>
<li><p>:q <span class="math inline">\(\quad\quad\quad\text{to quit vim}\)</span></p></li>
</ul>
<p>If you need to put a special piece of software inside a container you would google “how to install ____ on ubuntu”, because that is being installed.</p>
</div>
</div>
<div id="dockerfile" class="section level2">
<h2>Dockerfile</h2>
<p><img src="img/dockerfile_instructions.png" /></p>
<div id="copy-example" class="section level3">
<h3>COPY Example</h3>
<p>create a new hello world file.</p>
<p>Now add the following line to your dockerfile:</p>
<p>COPY hello_world.txt home/hello_wolrd.txt</p>
<p>In the sublime terminal:</p>
<ul>
<li><p>docker build -t ubuntu_plus_vim_plus_helloworld .</p></li>
<li><p>docker run -it ubuntu_plus_vim_plus_helloworld</p></li>
<li><p>ls</p></li>
<li><p>cd home</p></li>
<li><p>ls</p></li>
<li><p>cat hello_world.txt</p></li>
<li><p>exit</p></li>
</ul>
<p>This will be useful so that we can copy our code into the container.</p>
<p>### WORKDIR</p>
<p>Sets the working directory for all of your commands.</p>
<p>Reason: We don’t always know what the directories are within docker (like home in the previous example), so we want docker to the directory where our project lives.</p>
<p>Update Dockerfile with the following:</p>
<p><img src="img/dockerfile_img_03.png" /></p>
<p>In the terminal:</p>
<ul>
<li><p>docker build -t try_workdir .</p></li>
<li><p>docker run -it try_workdir /bin/bash</p></li>
</ul>
<p>Notice that we start out in the analysis_directory, and inside the directory is hello_world.txt.</p>
<ul>
<li>exit</li>
</ul>
<p>### CMD</p>
<p>Continers entry point: what is the container going to do by defualt?</p>
<p>Use cases:</p>
<ul>
<li><p>interactively run bash: CMD /bin/bash</p></li>
<li><p>open R: CMD [“R”]</p></li>
<li><p>run whole analysis and produce report: CMD Rscript -e “rmarkdown::render(…)”</p></li>
</ul>
</div>
</div>
</div>
<div id="part-3-11652--" class="section level1">
<h1>Part 3 (1:16:52 - )</h1>
</div>
